#include "minimax.h"
#include <fstream>

class TDLAgent {
private:
    double initialEpsilon;
    double initialAlpha;
    int games = 0;

	int numTuples = 68;
	int tupleLength = 8;
	int nTuples[68][8] = {
			{35, 36, 29, 37, 30, 23, 31, 17},
			{28, 14, 7, 36, 29, 22, 15, 8},
			{7, 0, 15, 8, 1, 16, 9, 2},
			{14, 22, 15, 8, 1, 16, 9, 2},
			{32, 25, 18, 11, 19, 20},
			{21, 14, 7, 22, 15, 23, 16, 24},
			{14, 7, 22, 15, 8, 23, 16, 9},
			{7, 8, 16, 24, 17, 10, 18, 11},
			{1, 2, 17, 3, 18, 11, 19, 20},
			{10, 32, 25, 18, 40, 26, 19, 34},
			{35, 36, 29, 22, 37, 30, 23, 16},
			{35, 36, 29, 37, 38, 16, 26, 27},
			{18, 26, 19, 12, 34, 27, 20, 13},
			{35, 36, 29, 37, 30, 23, 16, 24},
			{28, 21, 36, 29, 30, 23, 16, 24},
			{30, 23, 9, 38, 17, 10, 3, 39},
			{16, 9, 2, 24, 10, 3, 32, 33},
			{39, 25, 40, 33, 26, 19, 41, 34},
			{28, 21, 14, 22, 15, 30, 23, 17},
			{23, 16, 9, 17, 25, 33, 27, 20},
			{7, 0, 8, 1, 2, 10, 3, 4},
			{0, 15, 8, 1, 16, 9, 17, 18},
			{28, 21, 22, 15, 23, 16, 17, 25},
			{30, 38, 31, 39, 32, 25, 33, 26},
			{8, 23, 16, 9, 2, 24, 17, 3},
			{30, 24, 32, 25, 18, 26, 12, 6},
			{1, 9, 3, 11, 12, 5, 13, 6},
			{16, 24, 17, 10, 25, 26, 19, 20},
			{7, 15, 1, 16, 9, 10, 3, 4},
			{24, 18, 11, 19, 12, 5, 13, 6},
			{22, 15, 1, 16, 9, 10, 3, 4},
			{28, 21, 14, 36, 29, 22, 15, 30},
			{35, 28, 21, 36, 29, 22, 30, 23},
			{22, 23, 24, 32, 25, 33, 19, 27},
			{30, 38, 31, 24, 17, 25, 18, 19},
			{29, 22, 15, 37, 16, 31, 32, 40},
			{28, 21, 14, 22, 15, 8, 9, 2},
			{35, 28, 21, 36, 22, 37, 30, 38},
			{14, 7, 22, 15, 1, 23, 16, 17},
			{38, 31, 39, 40, 33, 26, 41, 34},
			{0, 8, 1, 9, 2, 17, 10, 18},
			{38, 39, 32, 40, 33, 26, 41, 34},
			{17, 32, 25, 18, 26, 39, 5, 6},
			{7, 8, 1, 9, 2, 17, 10, 18},
			{2, 3, 11, 4, 26, 19, 12, 5},
			{21, 14, 7, 0, 22, 15, 8, 1},
			{7, 8, 9, 17, 25, 26, 19, 27},
			{35, 36, 37, 31, 32, 33, 26, 19},
			{28, 21, 0, 22, 1, 16, 9, 2},
			{21, 14, 15, 8, 1, 9, 2, 10},
			{16, 9, 2, 17, 10, 3, 11, 4},
			{37, 30, 38, 31, 24, 25, 18, 19},
			{30, 23, 38, 24, 39, 32, 33, 34},
			{28, 21, 36, 29, 37, 30, 23, 24},
			{21, 7, 0, 29, 15, 8, 23, 31},
			{28, 21, 14, 29, 22, 30, 23, 24},
			{10, 3, 4, 33, 26, 19, 34, 27},
			{18, 11, 4, 33, 26, 19, 34, 27},
			{7, 0, 15, 8, 16, 24, 17, 10},
			{40, 33, 19, 12, 41, 34, 27, 20},
			{14, 7, 8, 1, 23, 16, 9, 2},
			{38, 31, 32, 25, 33, 26, 12, 20},
			{25, 18, 33, 26, 19, 27, 27, 20},
			{28, 21, 29, 23, 24, 18, 11, 4},
			{15, 23, 16, 24, 17, 10, 18, 26},
			{8, 23, 16, 24, 17, 10, 18, 26},
			{28, 36, 29, 37, 30, 24, 25, 18},
			{24, 17, 25, 18, 11, 19, 5, 13},
	};

	int numWeights = 4456448;
	double* weights;

	Actor player;
	bool training;
	double epsilon;
	double alpha;
	int lastBestValue = 0;
	TDLAgent* other;

	Connect4* game;
public:
    TDLAgent(bool isTraining, int player, double alphaInit, double epsilonInit);
	std::vector<int> getIndices(int** state1, int** state2);
	void computeAlpha();
	int updateWeights(int bestMove, double bestMoveValue);
	int getBestMove(int** board);
	void loadAgent(std::string fileName);
	void saveAgent(std::string fileName);

	double getAlpha();
	double getEpsilon();

	bool isTraining();
	void toggleTraining();

	void setOther(TDLAgent* other);
};
